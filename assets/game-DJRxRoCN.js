import"./common-pjiY56_e.js";class z{constructor(){this.size=8,this.rows=8,this.cols=8,this.cells=Array.from({length:this.size},()=>Array(this.size).fill(null))}getCell(t,e){return this.isWithinBounds(t,e)?this.cells[t][e]:null}isWithinBounds(t,e){return t>=0&&t<this.size&&e>=0&&e<this.size}placeBlockCheck(t,e,s){for(let i=0;i<t.length;i++)for(let o=0;o<t[i].length;o++)if(t[i][o]!==0){const l=e+o,r=s+i;if(!this.isWithinBounds(l,r)||this.cells[r][l]!==null)return!1}return!0}placeBlock(t,e,s,i="#eee"){t.forEach((o,l)=>{o.forEach((r,h)=>{r!==0&&(this.cells[s+l][e+h]={color:i})})})}getLinesToClear(){let t=[],e=[];for(let s=0;s<this.size;s++)this.cells[s].every(i=>i!==null)&&t.push(s);for(let s=0;s<this.size;s++){let i=!0;for(let o=0;o<this.size;o++)if(this.cells[o][s]===null){i=!1;break}i&&e.push(s)}return{rows:t,cols:e}}checkAndClearLines(){const{rows:t,cols:e}=this.getLinesToClear();return t.forEach(s=>this.cells[s].fill(null)),e.forEach(s=>{for(let i=0;i<this.size;i++)this.cells[i][s]=null}),{rows:t,cols:e}}canFitAnywhere(t){if(!t)return!1;for(let e=0;e<this.size;e++)for(let s=0;s<this.size;s++)if(this.placeBlockCheck(t,s,e))return!0;return!1}}class g{#t="green";#e;constructor(t,e){this.#t=t,this.#e=e,this.width=e[0].length,this.height=e.length}get shape(){return this.#e}get color(){return this.#t}}class w extends g{static shape=[[1,1,1]];constructor(t){super(t,w.shape)}}class v extends g{static shape=[[1,0],[1,0],[1,1]];constructor(t){super(t,v.shape)}}class k extends g{static shape=[[1]];constructor(t){super(t,k.shape)}}class m extends g{static shape=[[1,1],[1,1]];constructor(t){super(t,m.shape)}}class B extends g{static shape=[[1,1,1],[0,1,0]];constructor(t){super(t,B.shape)}}class x extends g{static shape=[[1],[1],[1]];constructor(t){super(t,x.shape)}}class b{constructor(){this.grid=new z,this.score=0,this.gameOver=!1,this.streak=0,this.offeredBlocks=[null,null,null],this.refreshBlocks(),this.highScore=parseInt(localStorage.getItem("codblast_highscore"))||0}refreshBlocks(){const t=[w,v,k,m,B,x],e=["#006769","#40A578","#9DDE8B","#E6FF94"];for(let s=0;s<3;s++)if(this.offeredBlocks[s]===null){const i=t[Math.floor(Math.random()*t.length)],o=e[Math.floor(Math.random()*e.length)];this.offeredBlocks[s]=new i(o)}}checkGameOver(){const t=this.offeredBlocks.filter(e=>e!==null);if(t.length===0)return!1;for(const e of t)for(let s=0;s<this.grid.size;s++)for(let i=0;i<this.grid.size;i++)if(this.grid.placeBlockCheck(e.shape,i,s))return!1;return this.gameOver=!0,!0}updateScore(t){this.score+=t,this.score>this.highScore&&(this.highScore=this.score,localStorage.setItem("codblast_highscore",this.highScore))}}function u(n,t,e,s,i,o,l,r=1){n.save(),n.globalAlpha=r,n.fillStyle=l,t.forEach((h,c)=>{h.forEach((a,p)=>{if(a!==0){const f=e+p*(i+o),C=s+c*(i+o);n.fillRect(f,C,i,i),n.strokeStyle="rgba(0, 0, 0, 0.1)",n.strokeRect(f,C,i,i)}})}),n.restore()}function R(n,t,e,s){const o=window.innerWidth*.9-40,l=Math.min(o,450);e.cellSize=l/8-e.padding;const r=8*(e.cellSize+e.padding)+e.padding,c=r+220;return n.width=r*s,n.height=c*s,n.style.width=`${r}px`,n.style.height=`${c}px`,r}class E{constructor(t,e,s){this.x=t,this.y=e,this.color=s,this.vx=(Math.random()-.5)*12,this.vy=(Math.random()-.5)*12,this.life=1,this.decay=Math.random()*.03+.02,this.size=Math.random()*4+2}update(){this.x+=this.vx,this.y+=this.vy,this.vy+=.1,this.life-=this.decay}draw(t){t.save(),t.globalAlpha=this.life,t.fillStyle=this.color,t.fillRect(this.x-this.size/2,this.y-this.size/2,this.size,this.size),t.restore()}}class L{constructor(t,e,s){this.canvas=t,this.ctx=t.getContext("2d"),this.grid=e,this.particles=[],this.gridHeight=0,this.options=Object.assign({cellSize:48,padding:2,lineColor:"#222",bgColor:"#0b0b0b",showGridLines:!0,highlightColor:"rgba(255,255,255,0.15)"},s),this.pixelRatio=Math.max(1,window.devicePixelRatio||1),this.resizeObserver=null,this.clickHandler=null,this.setup()}setup(){this.resizeObserver=()=>this.resize(),this.applyPixelRatio(),this.resizeObserver(),window.addEventListener("resize",this.resizeObserver),this.canvas.addEventListener("click",t=>{if(this.clickHandler){const e=this.canvas.getBoundingClientRect(),s=(t.clientX-e.left)*(this.canvas.width/e.width),i=(t.clientY-e.top)*(this.canvas.height/e.height),o=this.screenToCell(s,i);this.clickHandler(o)}},!1)}applyPixelRatio(){this.pixelRatio=Math.max(1,window.devicePixelRatio||1),this.ctx.setTransform(this.pixelRatio,0,0,this.pixelRatio,0,0)}resize(){this.gridHeight=R(this.canvas,this.grid,this.options,this.pixelRatio),this.applyPixelRatio(),this.render()}clear(){const t=this.ctx;t.save(),t.fillStyle=this.options.bgColor,t.fillRect(0,0,this.canvas.width/this.pixelRatio,this.canvas.height/this.pixelRatio),t.restore()}explodeLine(t,e){const s=this.options.cellSize,i=this.options.padding;for(let o=0;o<8;o++){let l,r,h;t==="row"?(l=i+o*(s+i)+s/2,r=i+e*(s+i)+s/2,h=this.grid.cells[e][o]?.color||"#fff"):(l=i+e*(s+i)+s/2,r=i+o*(s+i)+s/2,h=this.grid.cells[o][e]?.color||"#fff");for(let c=0;c<10;c++)this.particles.push(new E(l,r,h))}}render(t=null){if(this.clear(),this.drawGrid(),this.drawBlocks(),this.particles=this.particles.filter(e=>e.life>0),this.particles.forEach(e=>{e.update(),e.draw(this.ctx)}),this.drawTray(),t&&t.draggingBlock){const{draggingBlock:e,mouseX:s,mouseY:i}=t,o=this.options.cellSize,l=e.shape[0].length*o/2,r=e.shape.length*o/2,h=s-l,c=i-r,a=this.screenToCell(h,c);if(a&&this.grid.placeBlockCheck(e.shape,a.col,a.row)){const p=this.options.padding+a.col*(o+this.options.padding),f=this.options.padding+a.row*(o+this.options.padding);u(this.ctx,e.shape,p,f,o,this.options.padding,e.color,.3)}u(this.ctx,e.shape,h,c,o,this.options.padding,e.color,.7)}}drawTray(){const t=this.gridHeight+20,e=this.canvas.width/this.pixelRatio/3,s=this.options.cellSize*.8;this.grid.offeredBlocks&&this.grid.offeredBlocks.forEach((i,o)=>{if(!i)return;const l=i.shape[0].length*s,r=o*e+e/2-l/2;u(this.ctx,i.shape,r,t,s,this.options.padding,i.color)})}drawGrid(){const t=this.ctx,e=this.options,s=e.cellSize,i=e.padding,o=this.grid.cols,l=this.grid.rows;if(t.save(),t.fillStyle=e.bgColor,t.fillRect(0,0,this.canvas.width/this.pixelRatio,this.canvas.height/this.pixelRatio),e.showGridLines){t.strokeStyle=e.lineColor,t.lineWidth=1;for(let r=0;r<=l;r++){const h=i+r*(s+i)+.5;t.beginPath(),t.moveTo(i,h),t.lineTo(i+o*(s+i),h),t.stroke()}for(let r=0;r<=o;r++){const h=i+r*(s+i)+.5;t.beginPath(),t.moveTo(h,i),t.lineTo(h,i+l*(s+i)),t.stroke()}}t.restore()}drawBlocks(){const t=this.ctx,e=this.options,s=e.cellSize,i=e.padding;t.save();for(let o=0;o<this.grid.rows;o++)for(let l=0;l<this.grid.cols;l++){const r=this.grid.getCell(o,l);if(!r)continue;const h=i+l*(s+i),c=i+o*(s+i);t.fillStyle=r.color||"#eee",t.fillRect(h,c,s,s),t.strokeStyle=r.borderColor||"#222",t.lineWidth=2,t.strokeRect(h+1,c+1,s-2,s-2)}t.restore()}screenToCell(t,e){const s=this.options,i=s.cellSize,o=s.padding,l=Math.floor((t-o)/(i+o)),r=Math.floor((e-o)/(i+o));return r<0||r>=this.grid.rows||l<0||l>=this.grid.cols?null:{row:r,col:l}}highlightCell(t,e){if(t==null||e==null)return;const s=this.ctx,i=this.options,o=i.cellSize,l=i.padding,r=l+e*(o+l),h=l+t*(o+l);s.save(),s.fillStyle=i.highlightColor,s.fillRect(r,h,o,o),s.restore()}onClick(t){this.clickHandler=t}setGrid(t){this.grid=t,this.resize()}}class I{constructor(t,e){this.state=t,this.view=e}handleTurnEnd(){const t=this.state.grid.getLinesToClear(),e=t.rows.length+t.cols.length;if(e>0){t.rows.forEach(l=>this.view.explodeLine("row",l)),t.cols.forEach(l=>this.view.explodeLine("col",l)),this.state.grid.checkAndClearLines();let o=e*80;if(e>1){const l=(e-1)*50;o+=l}this.state.streak=(this.state.streak||0)+1,this.state.streak>1&&(o*=this.state.streak),this.state.score+=o}else this.state.streak=0,this.state.grid.checkAndClearLines();this.state.offeredBlocks.every(o=>o===null)&&(this.state.refreshBlocks(),this.state.grid.offeredBlocks=this.state.offeredBlocks),this.state.offeredBlocks.filter(o=>o!==null).some(o=>this.state.grid.canFitAnywhere(o.shape))||this.triggerGameOver(),this.view.render()}triggerGameOver(){const t=parseInt(localStorage.getItem("codblast_highscore"))||0;this.state.score>t&&localStorage.setItem("codblast_highscore",this.state.score);let e=parseInt(localStorage.getItem("codblast_games_played"))||0;e++,localStorage.setItem("codblast_games_played",e),alert(`Game Over! Final Score: ${this.state.score}`),window.location.href="index.html"}}class M{constructor(t,e,s){this.state=t,this.view=e,this.gameController=s,this.draggingBlock=null,this.dragIndex=-1,this.mouseX=0,this.mouseY=0,this.initListener()}initListener(){this.view.canvas.addEventListener("pointerdown",e=>this.handleDown(e)),window.addEventListener("pointermove",e=>this.handleMove(e)),window.addEventListener("pointerup",e=>this.handleUp(e))}handleDown(t){const e=this.view.canvas.getBoundingClientRect(),s=t.clientX-e.left,i=t.clientY-e.top,o=this.view.grid.rows*(this.view.options.cellSize+this.view.options.padding);if(i>o){const l=this.view.canvas.width/(this.view.pixelRatio*3),r=Math.floor(s/l),h=this.state.offeredBlocks[r];h&&(this.draggingBlock=h,this.dragIndex=r,console.log(`Picked up block from slot: ${r}`))}}handleMove(t){if(!this.draggingBlock)return;const e=this.view.canvas.getBoundingClientRect(),s=(t.clientX-e.left)*(this.view.canvas.width/e.width)/this.view.pixelRatio,i=(t.clientY-e.top)*(this.view.canvas.height/e.height)/this.view.pixelRatio;this.mouseX=s,this.mouseY=i;const o=this.draggingBlock.shape[0].length*this.view.options.cellSize/2,l=this.draggingBlock.shape.length*this.view.options.cellSize/2,r=this.view.screenToCell(s-o,i-l);this.view.render(this),r&&this.view.highlightCell(r.row,r.col)}handleUp(t){if(!this.draggingBlock)return;const e=this.draggingBlock.shape[0].length*this.view.options.cellSize/2,s=this.draggingBlock.shape.length*this.view.options.cellSize/2,i=this.view.screenToCell(this.mouseX-e,this.mouseY-s);if(i){const o=this.draggingBlock.shape,l=this.draggingBlock.color;this.state.grid.placeBlockCheck(o,i.col,i.row)&&(this.state.grid.placeBlock(o,i.col,i.row,l),this.state.offeredBlocks[this.dragIndex]=null,this.gameController.handleTurnEnd())}this.draggingBlock=null,this.dragIndex=-1,this.view.render()}}const T=document.getElementById("game-canvas"),X=document.getElementById("score-value"),d=new b;d.grid.offeredBlocks=d.offeredBlocks;const y=new L(T,d.grid),Y=new I(d,y),G=new M(d,y,Y);function S(){y.render(G),X.textContent=d.score,requestAnimationFrame(S)}document.getElementById("reset-btn").addEventListener("click",()=>{location.reload()});S();
